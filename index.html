<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walkthrough Checklist</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background-color: #f4f4f4;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        h2 {
            margin-top: 30px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
            color: #555;
        }

        ul {
            list-style: none;
            padding-left: 0;
        }

        li {
            margin-bottom: 10px;
            background-color: #fff;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            /* Add gap between elements inside li */
            transition: background-color 0.2s ease-in-out;
        }

        /* Allow label to grow */
        li label {
            flex-grow: 1;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
            flex-shrink: 0;
        }

        .checked-text {
            text-decoration: line-through;
            color: #818080;
        }

        /* --- Button Styles --- */
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .button-group button {
            padding: 10px 15px;
            font-size: 0.9em;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
        }

        #clearAllStorageButton {
            background-color: #dc3545;
        }

        #clearAllStorageButton:hover {
            background-color: #c82333;
        }

        #clearChecksButton {
            background-color: #ffc107;
            color: #333;
        }

        #clearChecksButton:hover {
            background-color: #e0a800;
        }

        #clearCustomObjectivesButton {
            background-color: #fd7e14;
        }

        #clearCustomObjectivesButton:hover {
            background-color: #e66a01;
        }

        /* Styles for the Add Objective Placeholder within each list */
        li.add-objective-placeholder {
            background-color: #f8f9fa;
            /* Lighter background */
            box-shadow: none;
            border: 1px dashed #ccc;
            padding: 8px 10px;
            /* Slightly less padding */
        }

        li.add-objective-placeholder input[type="text"] {
            flex-grow: 1;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
        }

        li.add-objective-placeholder button {
            padding: 5px 12px;
            cursor: pointer;
            background-color: #28a745;
            /* Green */
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            line-height: 1;
            flex-shrink: 0;
        }

        li.add-objective-placeholder button:hover {
            background-color: #218838;
        }

        /* Style for the remove button on custom objectives */
        .remove-objective-button {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0 5px;
            flex-shrink: 0;
            line-height: 1;
        }

        .remove-objective-button:hover {
            color: #a0232e;
        }

        /* --- Drag and Drop Styles --- */
        li.custom-objective-item[draggable="true"] {
            cursor: move;
            /* Indicate draggable */
        }

        li.dragging {
            opacity: 0.5;
            /* Make dragged item semi-transparent */
            background-color: #d0eaff;
            /* Light blue background */
        }

        /* Style for the visual indicator where the item will drop */
        .drag-over-indicator {
            border-top: 2px solid #0d6efd;
            /* Blue line indicator */
            /* Adjust margin to make space for the border without shifting content */
            margin-top: -2px;
        }

        /* Ensure placeholder isn't draggable */
        li.add-objective-placeholder {
            cursor: default;
        }
    </style>
</head>

<body>

    <h1>Last Epoch Leveling Guide</h1>

    <div class="button-group">
        <button id="clearAllStorageButton">Clear All Checks & Storage</button>
        <button id="clearChecksButton">Clear All Checks</button>
        <button id="clearCustomObjectivesButton">Clear Custom Objectives</button>
    </div>

    <h2>Act 1</h2>
    <ul id="act1-list" class="objective-list">
        <li><label><input type="checkbox" id="step-1"><span>Group up all mobs to 2nd phoenix, kill them to get to lvl 2.
                    Skip the rest.</span></label></li>
        <li><label><input type="checkbox" id="step-2"><span>Talk to the NPC in The Burning Forest (top dialogue choices)
                    to let him help you. Kill the end boss and go to town.</span></label></li>
        <li><label><input type="checkbox" id="step-3"><span>Skip all NPCs in The Keepers’ Camp and go to The Fortress
                    Gardens (north-west).</span></label></li>
        <li><label><input type="checkbox" id="step-4"><span>In The Fortress Walls enter The Storerooms to complete the
                    side quest. After leaving talk to the NPC and head north-east to The Keepers’s Vault.</span></label>
        </li>
        <li><label><input type="checkbox" id="step-5"><span>Talk to Keeper Barthas and continue north immediately. Enter
                    The Northern Road (north-east).</span></label></li>
        <li><label><input type="checkbox" id="step-6"><span>Speak with the Keeper Guard, portal to town and speak to NPC
                    (main quest), head out east to Ulatri Highlands.</span></label></li>
        <li><label><input type="checkbox" id="step-7"><span>Optionally kill big rares to get exp. Continue to The Osprix
                    Warcamp (north-east).</span></label></li>
        <li><label><input type="checkbox" id="step-8"><span>Continue to The Summit (north).</span></label></li>
        <li><label><input type="checkbox" id="step-9"><span>Kill Haruspex Orian (Act 1 boss). Portal to town and talk to
                    the 2 NPCs to get to Act 2.</span></label></li>
        <!-- Add Objective Placeholder -->
        <li class="add-objective-placeholder">
            <input type="text" placeholder="Add custom Act 1 objective..." />
            <button class="add-section-objective-button">+</button>
        </li>
    </ul>

    <h2>Act 2</h2>
    <ul id="act2-list" class="objective-list">
        <li><label><input type="checkbox" id="step-10"><span>Talk to NPC to take the Shard of the Epoch and continue
                    north. Skip the first NPC (main quest marker) and continue to Last Refuge Outskirts
                    (north).</span></label></li>
        <li><label><input type="checkbox" id="step-11"><span>Talk to the NPC to complete the quest, continue north, talk
                    to the first side quest NPC, complete the side quest (south-east à north-west à north-east).
                    Continue to north-east to kill the Void Penance. Enter The Council of Chambers.</span></label></li>
        <li><label><input type="checkbox" id="step-12"><span>Talk to the two NPCs to compete the quests and head
                    north-west to The Last Archive.</span></label></li>
        <li><label><input type="checkbox" id="step-13"><span>Enter Erza’s Library, complete the side quest, go back to
                    The Last Archive and continue north-east to Pannion’s Study.</span></label></li>
        <li><label><input type="checkbox" id="step-14"><span>Kill the Pannion’s Students. Portal back to
                    town.</span></label></li>
        <li><label><input type="checkbox" id="step-15"><span>Talk to NPCs (side quest north-east, complete side quest
                    west (unique gloves), complete main quest). Head north-east to The Precipice.</span></label></li>
        <li><label><input type="checkbox" id="step-16"><span>Kill the Idol of Ruin, go through the time rift, loop
                    around to the next time rift.</span></label></li>
        <li><label><input type="checkbox" id="step-17"><span>Back in The Precipice go east to The
                    Armoury.</span></label></li>
        <li><label><input type="checkbox" id="step-18"><span>Clear the waves and kill the boss. Continue north-east,
                    skip the side quest. Follow the main quest marker to The Lower District.</span></label></li>
        <li><label><input type="checkbox" id="step-19"><span>Kill the Elder Pannion. Talk to the NPC and enter the Time
                    Rift to The End of Time.</span></label></li>
        <li><label><input type="checkbox" id="step-20"><span>Run directly up the stairs, talk to Elder Gaspar, choose
                    Mastery, enter The Council Chamber.</span></label></li>
        <!-- Add Objective Placeholder -->
        <li class="add-objective-placeholder">
            <input type="text" placeholder="Add custom Act 2 objective..." />
            <button class="add-section-objective-button">+</button>
        </li>
    </ul>

    <h2>Act 3</h2>
    <ul id="act3-list" class="objective-list">
        <li><label><input type="checkbox" id="step-21"><span>Talk to NPCs (main quest, respec NPC) dispel barrier
                    south-east and enter The Sheltered Wood.</span></label></li>
        <li><label><input type="checkbox" id="step-22"><span>Follow main quest marker to The Surface, The Forsaken Trail
                    and Cultist Camp.</span></label></li>
        <li><label><input type="checkbox" id="step-23"><span>Directly head out north to The Ruins of
                    Welryn.</span></label></li>
        <li><label><input type="checkbox" id="step-24"><span>Spiral around to enter Welryn Undercity
                    (south).</span></label></li>
        <li><label><input type="checkbox" id="step-25"><span>Talk to NPC (main quest) and kill the three Soul
                    Repositories (north à east à south-east). Talk to NPC again and portal to town.</span></label></li>
        <li><label><input type="checkbox" id="step-26"><span>Directly go south to Welryn Docks.</span></label></li>
        <li><label><input type="checkbox" id="step-27"><span>Follow main quest marker, kill the Void Centipede, take
                    Symbol of Hope. Portal to town.</span></label></li>
        <li><label><input type="checkbox" id="step-28"><span>Talk to NPC (main quest). Go east to The Ritual
                    Site.</span></label></li>
        <li><label><input type="checkbox" id="step-29"><span>Talk to NPC (main quest) and kill the Void Amalgamation.
                    Continue east to The Shattered Valley.</span></label></li>
        <li><label><input type="checkbox" id="step-30"><span>Go directly north to The Abandoned Tunnel. Follow quest
                    marker to The Lost Refuge (north-east).</span></label></li>
        <li><label><input type="checkbox" id="step-31"><span>Follow quest marker (east), talk to the Old Tome to
                    complete the side quest (2 passives). Take waypoint to The Shattered Valley (a bit south of current
                    location).</span></label></li>
        <li><label><input type="checkbox" id="step-32"><span>Continue south-east, enter Time Rift to The Ancient Forest.
                    Go north-east and kill the Primeval Dragon. Take waypoint to The Shattered Valley in the Ruined
                    Era.</span></label></li>
        <li><label><input type="checkbox" id="step-33"><span>Go south-east again, pass the Time Rift towards north-east
                    (main quest marker). Enter The Courtyard.</span></label></li>
        <li><label><input type="checkbox" id="step-34"><span>Turn south-east at waypoint and follow north towards the
                    main quest marker. Kill the Temple Guardian and enter The Temple of Eterra.</span></label></li>
        <li><label><input type="checkbox" id="step-35"><span>Follow main quest marker (north-east) and enter The Lotus
                    Halls.</span></label></li>
        <li><label><input type="checkbox" id="step-36"><span>Directly go north-west to get one of the Shards (talk to
                    NPC (…), enter Time Rift, take shard), take waypoint to The Council Chambers.</span></label></li>
        <li><label><input type="checkbox" id="step-37"><span>Talk to NPC (respect NPC). Take waypoint to The Lotus
                    Halls. Continue north-east to The Sanctum Bastille.</span></label></li>
        <li><label><input type="checkbox" id="step-38"><span>Follow main quest marker to enter The End of Ruin. Kill the
                    Emperor’s Remains. Talk to NPC to portal to The End of Time.</span></label></li>
        <li><label><input type="checkbox" id="step-39"><span>Directly go upstairs to Elder Gaspar. Enter portal to
                    Imperial Era (The Outcast Camp).</span></label></li>
        <!-- Add Objective Placeholder -->
        <li class="add-objective-placeholder">
            <input type="text" placeholder="Add custom Act 3 objective..." />
            <button class="add-section-objective-button">+</button>
        </li>
    </ul>

    <h2>Act 4</h2>
    <ul id="act4-list" class="objective-list">
        <li><label><input type="checkbox" id="step-40"><span>Optionally craft a bit, head south-west to Welryn
                    Outskirts.</span></label></li>
        <li><label><input type="checkbox" id="step-41"><span>Follow quest marker (west) to enter Imperial
                    Welryn.</span></label></li>
        <li><label><input type="checkbox" id="step-42"><span>Ignore quest marker and go north-west to The Soul Wardens’
                    Road.</span></label></li>
        <li><label><input type="checkbox" id="step-43"><span>Kill the zombie waves and continue west to The Risen
                    Lake.</span></label></li>
        <li><label><input type="checkbox" id="step-44"><span>Enter Time Rift to The Corrupted Lake. Go west and spiral
                    around clockwise until you kill the Prophet of Ruin/Idol of Ruin (side quest). Take waypoint to The
                    Risen Lake.</span></label></li>
        <li><label><input type="checkbox" id="step-45"><span>Pass the Time Rift, click the stone for the bridge, ignore
                    quest marker and continue north-east and north-west to enter The Fallen Tower.</span></label></li>
        <li><label><input type="checkbox" id="step-46"><span>Follow quest marker (north-west) to enter Imperial
                    Thetima.</span></label></li>
        <li><label><input type="checkbox" id="step-47"><span>Follow quest marker (west) to enter The Darkling
                    Pier.</span></label></li>
        <li><label><input type="checkbox" id="step-48"><span>Continue east to enter The Imperial
                    Dreadnought.</span></label></li>
        <li><label><input type="checkbox" id="step-49"><span>Follow quest marker (east) to enter The Dreadnought’s
                    Deck.</span></label></li>
        <li><label><input type="checkbox" id="step-50"><span>Follow quest marker (north-west, then west), kill Admiral
                    Harton. Talk to NPCs (Alric) and the Dreadnought’s Railing.</span></label></li>
        <!-- Add Objective Placeholder -->
        <li class="add-objective-placeholder">
            <input type="text" placeholder="Add custom Act 4 objective..." />
            <button class="add-section-objective-button">+</button>
        </li>
    </ul>

    <h2>Act 5</h2>
    <ul id="act5-list" class="objective-list">
        <li><label><input type="checkbox" id="step-51"><span>Talk to NPC (Alric). Go north-east to enter The Majasan
                    Desert.</span></label></li>
        <li><label><input type="checkbox" id="step-52"><span>Follow quest marker (north-east), talk to NPC (side quest,
                    Rouj Zabat), enter The Wraith Dunes.</span></label></li>
        <li><label><input type="checkbox" id="step-53"><span>Go north and north-east, follow main quest marker to enter
                    Maj’elka.</span></label></li>
        <li><label><input type="checkbox" id="step-54"><span>Talk to NPC (Alric), go downstairs on the right, continue
                    south-east to main quest marker, kill Venator Ealos, talk to NPC (Alric), continue north-east to
                    main quest marker, on the way talk to NPC lying on the ground (side quest, Rouj Zabat). Continue
                    north (left main quest marker), kill the Bone Furnace. Follow the north-east main quest marker to
                    enter The Sapphire Quarter.</span></label></li>
        <li><label><input type="checkbox" id="step-55"><span>Continue north, kill the Stygian Warden, talk to NPC
                    (Alric), continue north-west and north to main quest marker, kill Praetor Vul’arta, talk to NPC
                    (Alric), enter portal to Maj’elka.</span></label></li>
        <li><label><input type="checkbox" id="step-56"><span>Go east to The Oracle’s Abode. Talk to NPC (side quest,
                    Shrine Maiden). Take waypoint to The Shining Cove.</span></label></li>
        <li><label><input type="checkbox" id="step-57"><span>Go east, enter the Time Rift into The Ruined Coast. Follow
                    the path, kill Ortra’ek the Survivor, click the Sapphire Tablet, enter the Temporal Sanctum to get
                    the waypoint. Take waypoint to The Oracle’s Abode (Imperial Era).</span></label></li>
        <li><label><input type="checkbox" id="step-58"><span>Talk to NPC (side quest, Shrine Maiden). Talk to the Oracle
                    (main quest) and continue north to The Maj’elkan Catacombs.</span></label></li>
        <li><label><input type="checkbox" id="step-59"><span>Go east à south à north-east to follow the main quest
                    marker and enter Titan’s Canyon.</span></label></li>
        <li><label><input type="checkbox" id="step-60"><span>Follow main quest marker, kill Spymaster Zerrick, enter The
                    Maj’elka Waystation.</span></label></li>
        <li><label><input type="checkbox" id="step-61"><span>Follow main quest marker, talk to NPC
                    (Alric).</span></label></li>
        <!-- Add Objective Placeholder -->
        <li class="add-objective-placeholder">
            <input type="text" placeholder="Add custom Act 5 objective..." />
            <button class="add-section-objective-button">+</button>
        </li>
    </ul>

    <h2>Act 6</h2>
    <ul id="act6-list" class="objective-list">
        <li><label><input type="checkbox" id="step-62"><span>Talk to NPC (Yulia), go north into The Rust
                    Lands.</span></label></li>
        <li><label><input type="checkbox" id="step-63"><span>Follow main quest marker (east), enter The Lower
                    Sewers.</span></label></li>
        <li><label><input type="checkbox" id="step-64"><span>Follow main quest marker (north à north-west), enter The
                    Barren Aqueduct.</span></label></li>
        <li><label><input type="checkbox" id="step-65"><span>Follow main quest marker (north à north-west), kill the
                    rare mob, talk to NPC (Alric), enter Necropolis of the Deep.</span></label></li>
        <li><label><input type="checkbox" id="step-66"><span>Follow main quest marker (south-east), enter Yulia’s
                    Haven.</span></label></li>
        <li><label><input type="checkbox" id="step-67"><span>Talk to both NPCs (side and main quest), continue
                    north-west into Nests of the Fallen.</span></label></li>
        <li><label><input type="checkbox" id="step-68"><span>Follow side quest marker, kill Ulaca Maggot Tongue. Portal
                    to town.</span></label></li>
        <li><label><input type="checkbox" id="step-69"><span>Talk to NPC (side quest, Alric), enter The Upper Necropolis
                    (south-east).</span></label></li>
        <li><label><input type="checkbox" id="step-70"><span>Follow main quest marker (north-east), enter The Citadel
                    Sewers.</span></label></li>
        <li><label><input type="checkbox" id="step-71"><span>Destroy the three Imperial Watchers (main quest markers,
                    clockwise). Continue south-east (main quest marker), enter The Immortal Summit.</span></label></li>
        <li><label><input type="checkbox" id="step-72"><span>Go south-east, then north-east (main quest marker), enter
                    The Immortal Cidatel.</span></label></li>
        <li><label><input type="checkbox" id="step-73"><span>Talk to NPC (main quest, Yulia), kill Pontifex Yulia,
                    Admiral Harton and Spymaster Zerrick. Talk to NPC (Yulia).</span></label></li>
        <!-- Add Objective Placeholder -->
        <li class="add-objective-placeholder">
            <input type="text" placeholder="Add custom Act 6 objective..." />
            <button class="add-section-objective-button">+</button>
        </li>
    </ul>

    <h2>Act 7</h2>
    <ul id="act7-list" class="objective-list">
        <li><label><input type="checkbox" id="step-74"><span>Go south-west, then north-west/west towards the main quest
                    marker, enter The Burning Forest.</span></label></li>
        <li><label><input type="checkbox" id="step-75"><span>Follow main quest marker (south-west), enter The Scorched
                    Grove. Help and talk to NPC (Heorot), talk to NPC (Yulia).</span></label></li>
        <li><label><input type="checkbox" id="step-76"><span>In town, talk to NPC (Chieftan Yulia) and side quest NPC
                    (Medicine Man), enter The Heoborean Forest (west).</span></label></li>
        <li><label><input type="checkbox" id="step-77"><span>Enter The Ice Caverns (north). Acquire a Bitterwing fang
                    (north-west marker). Take waypoint to The Heoborean Forest.</span></label></li>
        <li><label><input type="checkbox" id="step-78"><span>Continue west to quest marker, enter The Nomad Camp. Talk
                    to NPC (main quest, Nomad Survivor). Follow quest marker (west), enter The Wengari
                    Fortress.</span></label></li>
        <li><label><input type="checkbox" id="step-79"><span>Follow side quest markers to find the right camp (start
                    north-east). Kill Wengari Beastmaster. Follow main quest marker (north), kill Wengari Matriarch and
                    Patriarch. Talk to NPC (Blessed Horn). Continue south-west (side quest marker). Take waypoint to The
                    Ice Caverns.</span></label></li>
        <li><label><input type="checkbox" id="step-80"><span>Go north-east / north (main and side quest marker), enter
                    The Tundra.</span></label></li>
        <li><label><input type="checkbox" id="step-81"><span>Kill the Eber (north) and continue north (main quest
                    marker), talk to NPC (cliff edge), enter The Temple of Heorot.</span></label></li>
        <li><label><input type="checkbox" id="step-82"><span>Follow main quest marker (north), skip the Spreading Frost
                    and enter Farwood.</span></label></li>
        <li><label><input type="checkbox" id="step-83"><span>Continue north-east (main quest marker), enter The Frozen
                    Roots.</span></label></li>
        <li><label><input type="checkbox" id="step-84"><span>Talk to NPC (main quest, Grael), continue north-east (main
                    quest marker), enter The Tomb of Morditas. Kill the Frostroot Warden. Talk to NPC (Lance of Heorot
                    and Grael).</span></label></li>
        <li><label><input type="checkbox" id="step-85"><span>Hand in quests in town (side and main
                    quests).</span></label></li>
        <!-- Add Objective Placeholder -->
        <li class="add-objective-placeholder">
            <input type="text" placeholder="Add custom Act 7 objective..." />
            <button class="add-section-objective-button">+</button>
        </li>
    </ul>

    <h2>Endgame</h2>
    <ul id="endgame-list" class="objective-list">
        <li><label><input type="checkbox" id="step-end-1"><span>Start running Monos, look for a temporal sanctum
                    key.</span></label></li>
        <li><label><input type="checkbox" id="step-end-2"><span>Run temporal sanctum and exit to act 9.</span></label>
        </li>
        <li><label><input type="checkbox" id="step-end-3"><span>Finish act 9, run additional dungeons, continue farming
                    monos.</span></label></li>
        <li><label><input type="checkbox" id="step-end-4"><span>Get some rest, you earned it!</span></label></li>
        <!-- Add Objective Placeholder -->
        <li class="add-objective-placeholder">
            <input type="text" placeholder="Add custom Endgame objective..." />
            <button class="add-section-objective-button">+</button>
        </li>
    </ul>

    <!-- Removed the separate Custom Objectives section -->

    <script>
        // --- DOM Elements ---
        // Select ALL checkboxes initially for clearing/loading predefined ones with IDs
        const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
        const predefinedCheckboxes = document.querySelectorAll('.objective-list li:not(.custom-objective-item):not(.add-objective-placeholder) input[type="checkbox"]');
        const objectiveLists = document.querySelectorAll('ul.objective-list'); // Get all lists
        const clearAllStorageButton = document.getElementById('clearAllStorageButton');
        const clearChecksButton = document.getElementById('clearChecksButton');
        const clearCustomObjectivesButton = document.getElementById('clearCustomObjectivesButton');
        // Note: Add buttons are handled via event delegation

        // --- Storage Keys ---
        const predefinedStorageKey = 'checklistState'; // Key for predefined checkbox states (using their IDs)
        const customStorageKey = 'customObjectivesData'; // Key for custom objectives array {sectionId, text, checked}

        // --- State Variables ---
        let draggedItem = null; // Keep track of the element being dragged

        // --- Utility Functions ---

        // Updates the visual style of a checkbox label based on checked state
        function updateStyle(checkbox) {
            const label = checkbox.closest('label');
            const textSpan = label?.querySelector('span'); // Prefer styling the span if it exists
            const targetElement = textSpan || label; // Fallback to styling the label

            if (targetElement) {
                if (checkbox.checked) {
                    targetElement.classList.add('checked-text');
                } else {
                    targetElement.classList.remove('checked-text');
                }
            }
        }

        // --- Predefined Objectives Logic ---

        // Saves the state of predefined checkboxes (those with IDs) to localStorage
        function savePredefinedState() {
            const state = {};
            // Iterate only through predefined checkboxes identified earlier
            predefinedCheckboxes.forEach(cb => {
                if (cb.id) {
                    state[cb.id] = cb.checked;
                }
            });
            localStorage.setItem(predefinedStorageKey, JSON.stringify(state));
        }

        // Loads the state of predefined checkboxes from localStorage
        function loadPredefinedState() {
            const savedState = localStorage.getItem(predefinedStorageKey);
            let state = {};
            if (savedState) {
                try {
                    state = JSON.parse(savedState);
                } catch (e) {
                    console.error("Error parsing predefined checklist state from localStorage:", e);
                    localStorage.removeItem(predefinedStorageKey); // Clear potentially corrupted state
                }
            }

            // Iterate through predefined checkboxes and apply state or default
            predefinedCheckboxes.forEach(cb => {
                if (cb.id && state.hasOwnProperty(cb.id)) {
                    cb.checked = state[cb.id];
                } else {
                    cb.checked = false; // Default to unchecked if not found or no ID
                }
                updateStyle(cb); // Update style based on loaded/default state
            });
        }


        // --- Custom Objectives Logic ---

        // Creates the HTML elements for a single custom objective
        function createCustomObjectiveElement(objData) { // objData = { text: string, checked: boolean }
            const li = document.createElement('li');
            li.classList.add('custom-objective-item'); // Mark this as a custom item
            li.draggable = true; // Make it draggable

            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            const span = document.createElement('span');
            const removeButton = document.createElement('button');

            checkbox.type = 'checkbox';
            checkbox.checked = objData.checked || false;
            span.textContent = objData.text;

            removeButton.textContent = '×';
            removeButton.className = 'remove-objective-button';
            removeButton.title = 'Remove objective';

            // Event listener for the checkbox CHANGE (specific to custom items)
            checkbox.addEventListener('change', () => {
                updateStyle(checkbox);
                saveCustomObjectives(); // Save when state changes
            });

            // Event listener for the REMOVE button
            removeButton.addEventListener('click', () => {
                li.remove(); // Remove the list item from the DOM
                saveCustomObjectives(); // Save the updated list
            });


            label.appendChild(checkbox);
            label.appendChild(span);
            li.appendChild(label);
            li.appendChild(removeButton);

            // Drag and Drop Listeners
            li.addEventListener('dragstart', handleDragStart);
            li.addEventListener('dragend', handleDragEnd);


            updateStyle(checkbox); // Apply initial style

            return li;
        }

        // Saves the current list of ALL custom objectives across sections to localStorage
        function saveCustomObjectives() {
            const customObjectivesData = [];
            const objectiveLists = document.querySelectorAll('ul.objective-list');

            objectiveLists.forEach(ul => {
                const sectionId = ul.id;
                if (!sectionId) {
                    console.warn("Objective list found without an ID, cannot save custom objectives for it:", ul);
                    return; // Skip lists without IDs
                }

                // Select only custom objective items within this specific list
                ul.querySelectorAll('li.custom-objective-item').forEach(li => {
                    const checkbox = li.querySelector('input[type="checkbox"]');
                    const span = li.querySelector('span');
                    if (checkbox && span) {
                        customObjectivesData.push({
                            sectionId: sectionId,
                            text: span.textContent,
                            checked: checkbox.checked
                        });
                    }
                });
            });
            localStorage.setItem(customStorageKey, JSON.stringify(customObjectivesData));
        }

        // Loads custom objectives from localStorage and displays them in their respective sections
        function loadCustomObjectives() {
            // Clear existing dynamically added custom objectives first
            document.querySelectorAll('li.custom-objective-item').forEach(item => item.remove());

            const savedCustomObjectives = localStorage.getItem(customStorageKey);
            if (savedCustomObjectives) {
                try {
                    const customObjectivesData = JSON.parse(savedCustomObjectives);
                    if (Array.isArray(customObjectivesData)) {
                        customObjectivesData.forEach(objData => {
                            const targetList = document.getElementById(objData.sectionId);
                            const placeholder = targetList?.querySelector('.add-objective-placeholder');

                            if (targetList && placeholder) {
                                // Create the element using only text and checked state
                                const li = createCustomObjectiveElement({ text: objData.text, checked: objData.checked });
                                // Insert the new custom item *before* the placeholder in its section
                                targetList.insertBefore(li, placeholder);
                            } else {
                                console.warn(`Could not find target list #${objData.sectionId} or its placeholder for custom objective:`, objData.text);
                            }
                        });
                    } else {
                        console.error("Custom objectives data is not an array:", customObjectivesData);
                        localStorage.removeItem(customStorageKey); // Clear invalid data
                    }
                } catch (e) {
                    console.error("Error parsing custom objectives from localStorage:", e);
                    localStorage.removeItem(customStorageKey); // Clear potentially corrupted data
                }
            }
        }

        // Adds a new custom objective to the specific section where the button was clicked
        function addCustomObjective(addButton) {
            const placeholderLi = addButton.closest('.add-objective-placeholder');
            const inputField = placeholderLi?.querySelector('input[type="text"]');
            const targetList = placeholderLi?.closest('ul.objective-list');

            if (!inputField || !targetList || !targetList.id) {
                console.error("Could not find input field or target list ID for adding objective.");
                return;
            }

            const text = inputField.value.trim();
            if (text) {
                const newObjData = { text: text, checked: false };
                const li = createCustomObjectiveElement(newObjData);

                // Insert the new item before the placeholder li
                targetList.insertBefore(li, placeholderLi);

                saveCustomObjectives(); // Save the updated list including the new item
                inputField.value = ''; // Clear the input field for that section
                inputField.focus();
            }
        }

        // --- Drag and Drop Handlers ---

        function handleDragStart(event) {
            // Only allow dragging custom items
            if (event.target.classList.contains('custom-objective-item')) {
                draggedItem = event.target;
                // Set data to identify the drag source list (optional but good practice)
                event.dataTransfer.setData('text/plain', draggedItem.closest('ul.objective-list').id);
                event.dataTransfer.effectAllowed = 'move'; // Indicate the type of drag
                // Add slight delay so the browser has time to render the drag image
                setTimeout(() => {
                    draggedItem.classList.add('dragging');
                }, 0);
            } else {
                event.preventDefault(); // Prevent dragging non-custom items
            }
        }

        function handleDragEnd(event) {
            if (draggedItem) {
                // Clean up styles regardless of drop success
                draggedItem.classList.remove('dragging');
                // Remove any lingering indicators
                document.querySelectorAll('.drag-over-indicator').forEach(indicator => {
                    indicator.classList.remove('drag-over-indicator');
                });
                draggedItem = null;
            }
        }

        function handleDragOver(event) {

            event.preventDefault(); // Necessary to allow dropping
            if (!draggedItem) return; // Only handle if an item is being dragged

            const targetList = event.target.closest('ul.objective-list');
            // Ensure we are dropping within the *same* list the drag started from
            const sourceListId = event.dataTransfer.getData('text/plain');
            if (!targetList || targetList.id !== sourceListId) {
                event.dataTransfer.dropEffect = 'none'; // Indicate invalid drop target
                return;
            }
            event.dataTransfer.dropEffect = 'move'; // Indicate valid drop target


            const afterElement = getDragAfterElement(targetList, event.clientY);

            // Remove previous indicators
            targetList.querySelectorAll('.drag-over-indicator').forEach(indicator => {
                indicator.classList.remove('drag-over-indicator');
            });

            // Add indicator to the element we're hovering over/before
            if (afterElement) {
                afterElement.classList.add('drag-over-indicator');
            } else {
                // If no element is returned, it means drop at the end.
                // Optionally, add indicator to the placeholder or list itself.
                const placeholder = targetList.querySelector('.add-objective-placeholder');
                if (placeholder) {
                    placeholder.classList.add('drag-over-indicator');
                }
            }
        }


        function handleDrop(event) {
            console.log('hereee')
            event.preventDefault(); // Prevent default drop behavior
            if (!draggedItem) return;

            const targetList = event.target.closest('ul.objective-list');
            // Double-check drop target validity (redundant but safe)
            const sourceListId = event.dataTransfer.getData('text/plain');
            if (!targetList || targetList.id !== sourceListId) {
                console.log("no dorp")
                return; // Invalid drop
            }

            const afterElement = getDragAfterElement(targetList, event.clientY);

            // Insert the dragged item at the determined position
            if (afterElement) {
                targetList.insertBefore(draggedItem, afterElement);
            } else {
                // If dropping at the end, insert before the placeholder
                const placeholder = targetList.querySelector('.add-objective-placeholder');
                targetList.insertBefore(draggedItem, placeholder);
            }

            // Remove indicator classes after drop
            targetList.querySelectorAll('.drag-over-indicator').forEach(indicator => {
                indicator.classList.remove('drag-over-indicator');
            });

            saveCustomObjectives(); // Save the new order!
        }

        // Helper function to find the element to insert before
        function getDragAfterElement(container, y) {
            // Get all draggable items in the container, excluding the one being dragged
            const draggableElements = [...container.querySelectorAll('li.custom-objective-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                // Calculate vertical midpoint of the element
                const offset = y - box.top - box.height / 2;
                // We want the element where the mouse is *above* its midpoint (negative offset)
                // and closer to zero than the current closest element
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element; // Initial closest has worst possible offset
        }




        // --- Clearing Functions ---

        // Clears ONLY the checkmarks from ALL objectives (predefined and custom)
        function clearAllChecks() {
            if (confirm("Are you sure you want to clear all check marks? This will not remove custom objectives.")) {
                // Uncheck ALL checkboxes in the document
                allCheckboxes.forEach(cb => {
                    cb.checked = false;
                    updateStyle(cb);
                });

                // Clear saved state for predefined checks
                localStorage.removeItem(predefinedStorageKey);
                // Resave custom objectives with unchecked state (important!)
                saveCustomObjectives();
            }
        }


        // Clears ONLY the custom objectives list items and their storage
        function clearCustomObjectives() {
            if (confirm("Are you sure you want to clear all custom objectives from all sections? This cannot be undone.")) {
                // Remove all custom list items from the DOM
                document.querySelectorAll('li.custom-objective-item').forEach(item => item.remove());
                // Remove custom objectives data from storage
                localStorage.removeItem(customStorageKey);
            }
        }

        // Clears ALL checkmarks AND custom objectives AND all storage
        function clearAllStorage() {
            if (confirm("WARNING: This will clear ALL check marks AND remove ALL custom objectives permanently from all sections. Are you sure?")) {
                // Clear all checks (unchecks everything visually)
                allCheckboxes.forEach(cb => {
                    cb.checked = false;
                    updateStyle(cb);
                });

                // Clear predefined storage
                localStorage.removeItem(predefinedStorageKey);

                // Clear custom objectives from DOM and storage
                document.querySelectorAll('li.custom-objective-item').forEach(item => item.remove());
                localStorage.removeItem(customStorageKey);
            }
        }

        // --- Event Listeners Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPredefinedState();
            loadCustomObjectives();
        });

        // Add dragover and drop listeners to each objective list container
        objectiveLists.forEach(list => {
            list.addEventListener('dragover', handleDragOver);
            // dragleave listener can be added to remove indicators if needed, but drop/dragend usually suffice
            // list.addEventListener('dragleave', handleDragLeave);
            list.addEventListener('drop', handleDrop);
        });


        // Event Delegation for adding custom objectives within sections
        document.body.addEventListener('click', function (event) {
            // Check if the clicked element is an add button within a placeholder
            if (event.target && event.target.classList.contains('add-section-objective-button')) {
                addCustomObjective(event.target);
            }
            // Check if the clicked element is a checkbox within a predefined objective (identified by having an ID)
            else if (event.target && event.target.matches('.objective-list li:not(.custom-objective-item) input[type="checkbox"][id]')) {
                updateStyle(event.target);
                savePredefinedState();
            }
            // Note: Checkbox changes for *custom* objectives are handled by listeners added in createCustomObjectiveElement
        });

        // Event Delegation for Enter key press in placeholder inputs
        document.body.addEventListener('keypress', function (event) {
            if (event.key === 'Enter' && event.target && event.target.matches('.add-objective-placeholder input[type="text"]')) {
                // Find the corresponding button and trigger the add function
                const placeholderLi = event.target.closest('.add-objective-placeholder');
                const addButton = placeholderLi?.querySelector('.add-section-objective-button');
                if (addButton) {
                    addCustomObjective(addButton);
                    event.preventDefault(); // Prevent potential form submission if wrapped in one
                }
            }
        });


        // Listeners for the main clear buttons
        clearAllStorageButton.addEventListener('click', clearAllStorage);
        clearChecksButton.addEventListener('click', clearAllChecks);
        clearCustomObjectivesButton.addEventListener('click', clearCustomObjectives);

    </script>
</body>

</html>