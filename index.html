<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walkthrough Checklist</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background-color: #f4f4f4;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        h2 {
            margin-top: 10px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
            color: #555;
        }

        ul {
            list-style: none;
            padding-left: 0;
        }

        li {
            margin-bottom: 10px;
            background-color: #fff;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            /* Add gap between elements inside li */
            transition: background-color 0.2s ease-in-out;
        }

        /* Allow label to grow */
        li label {
            flex-grow: 1;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
            flex-shrink: 0;
        }

        .checked-text {
            text-decoration: line-through;
            color: #818080;
        }

        /* --- Button Styles --- */
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .button-group button {
            padding: 10px 15px;
            font-size: 0.9em;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
        }

        #clearAllStorageButton {
            background-color: #dc3545;
        }

        #clearAllStorageButton:hover {
            background-color: #c82333;
        }

        #clearChecksButton {
            background-color: #ffc107;
            color: #333;
        }

        #clearChecksButton:hover {
            background-color: #e0a800;
        }

        #clearCustomObjectivesButton {
            background-color: #fd7e14;
        }

        #clearCustomObjectivesButton:hover {
            background-color: #e66a01;
        }

        /* Styles for the Add Objective Placeholder within each list */
        li.add-objective-placeholder {
            background-color: #f8f9fa;
            /* Lighter background */
            box-shadow: none;
            border: 1px dashed #ccc;
            padding: 8px 10px;
            /* Slightly less padding */
        }

        li.add-objective-placeholder input[type="text"] {
            flex-grow: 1;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
        }

        li.add-objective-placeholder button {
            padding: 5px 12px;
            cursor: pointer;
            background-color: #28a745;
            /* Green */
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            line-height: 1;
            flex-shrink: 0;
        }

        li.add-objective-placeholder button:hover {
            background-color: #218838;
        }

        /* Style for the remove button on custom objectives */
        .remove-objective-button {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0 5px;
            flex-shrink: 0;
            line-height: 1;
        }

        .remove-objective-button:hover {
            color: #a0232e;
        }

        /* --- Drag and Drop Styles --- */
        li.custom-objective-item[draggable="true"] {
            cursor: move;
            /* Indicate draggable */
        }

        li.dragging {
            opacity: 0.5;
            /* Make dragged item semi-transparent */
            background-color: #d0eaff;
            /* Light blue background */
        }

        /* Style for the visual indicator where the item will drop */
        .drag-over-indicator {
            border-top: 2px solid #0d6efd;
            /* Blue line indicator */
            /* Adjust margin to make space for the border without shifting content */
            margin-top: -2px;
        }

        /* Ensure placeholder isn't draggable */
        li.add-objective-placeholder {
            cursor: default;
        }

        /* --- Collapsible Section Styles --- */
        .section {
            margin-bottom: 0px;
            border-radius: 6px;
            background: #f4f4f4;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
            padding-bottom: 0px;
        }

        .section.collapsed ul.objective-list {
            display: none;
        }

        .section.collapsed h2 {
            border-bottom: none;
        }

        .collapse-toggle {
            background: none;
            border: none;
            font-size: 1.1em;
            margin-right: 8px;
            cursor: pointer;
            color: #555;
            transition: color 0.2s;
        }

        .collapse-toggle:focus {
            outline: 2px solid #0d6efd;
        }

        .section.collapsed .collapse-toggle {
            color: #0d6efd;
        }

        .section h2 {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Add styles for images in custom objectives */
        .custom-objective-image {
            max-width: 48px;
            max-height: 48px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            object-fit: cover;
            cursor: pointer;
            flex-shrink: 0;
        }

        .add-objective-placeholder.dragover {
            background-color: #e3ffe3;
            border-color: #28a745;
        }

        /* Modal for full-size image */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }

        .image-modal.active {
            display: flex;
        }

        .image-modal img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 16px #0008;
        }

        .image-modal-close {
            position: absolute;
            top: 24px;
            right: 32px;
            font-size: 2em;
            color: #fff;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 10000;
        }

        .custom-objective-edit-input {
            flex-grow: 1;
            font-size: 1em;
            padding: 2px 6px;
            margin-left: 0;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>

    <h1>Last Epoch Leveling Guide</h1>

    <div class="button-group">
        <button id="clearAllStorageButton">Reset All</button>
        <button id="clearChecksButton">Clear All Checks</button>
        <button id="clearCustomObjectivesButton">Delete All Custom</button>
    </div>

    <div class="section" id="section-act1">
        <h2><button class="collapse-toggle" aria-label="Collapse/Expand Act 1" tabindex="0">▼</button>Act 1</h2>
        <ul id="act1-list" class="objective-list">
            <li><label><input type="checkbox" id="step-1"><span>Group up all mobs to 2nd phoenix, kill them to get to
                        lvl 2.
                        Skip the rest.</span></label></li>
            <li><label><input type="checkbox" id="step-2"><span>Talk to the NPC in The Burning Forest (top dialogue
                        choices)
                        to let him help you. Kill the end boss and go to town.</span></label></li>
            <li><label><input type="checkbox" id="step-3"><span>Skip all NPCs in The Keepers’ Camp and go to The
                        Fortress
                        Gardens (north-west).</span></label></li>
            <li><label><input type="checkbox" id="step-4"><span>In The Fortress Walls enter The Storerooms to complete
                        the
                        side quest. After leaving talk to the NPC and head north-east to The Keepers’s
                        Vault.</span></label>
            </li>
            <li><label><input type="checkbox" id="step-5"><span>Talk to Keeper Barthas and continue north immediately.
                        Enter
                        The Northern Road (north-east).</span></label></li>
            <li><label><input type="checkbox" id="step-6"><span>Speak with the Keeper Guard, portal to town and speak to
                        NPC
                        (main quest), head out east to Ulatri Highlands.</span></label></li>
            <li><label><input type="checkbox" id="step-7"><span>Optionally kill big rares to get exp. Continue to The
                        Osprix
                        Warcamp (north-east).</span></label></li>
            <li><label><input type="checkbox" id="step-8"><span>Continue to The Summit (north).</span></label></li>
            <li><label><input type="checkbox" id="step-9"><span>Kill Haruspex Orian (Act 1 boss). Portal to town and
                        talk to
                        the 2 NPCs to get to Act 2.</span></label></li>
            <!-- Add Objective Placeholder -->
            <li class="add-objective-placeholder" tabindex="0">
                <input type="text" placeholder="Add custom Act 1 objective..." />
                <button class="add-section-objective-button">+</button>
            </li>
        </ul>
    </div>

    <div class="section" id="section-act2">
        <h2><button class="collapse-toggle" aria-label="Collapse/Expand Act 2" tabindex="0">▼</button>Act 2</h2>
        <ul id="act2-list" class="objective-list">
            <li><label><input type="checkbox" id="step-10"><span>Talk to NPC to take the Shard of the Epoch and continue
                        north. Skip the first NPC (main quest marker) and continue to Last Refuge Outskirts
                        (north).</span></label></li>
            <li><label><input type="checkbox" id="step-11"><span>Talk to the NPC to complete the quest, continue north,
                        talk
                        to the first side quest NPC, complete the side quest (south-east à north-west à north-east).
                        Continue to north-east to kill the Void Penance. Enter The Council of Chambers.</span></label>
            </li>
            <li><label><input type="checkbox" id="step-12"><span>Talk to the two NPCs to compete the quests and head
                        north-west to The Last Archive.</span></label></li>
            <li><label><input type="checkbox" id="step-13"><span>Enter Erza’s Library, complete the side quest, go back
                        to
                        The Last Archive and continue north-east to Pannion’s Study.</span></label></li>
            <li><label><input type="checkbox" id="step-14"><span>Kill the Pannion’s Students. Portal back to
                        town.</span></label></li>
            <li><label><input type="checkbox" id="step-15"><span>Talk to NPCs (side quest north-east, complete side
                        quest
                        west (unique gloves), complete main quest). Head north-east to The Precipice.</span></label>
            </li>
            <li><label><input type="checkbox" id="step-16"><span>Kill the Idol of Ruin, go through the time rift, loop
                        around to the next time rift.</span></label></li>
            <li><label><input type="checkbox" id="step-17"><span>Back in The Precipice go east to The
                        Armoury.</span></label></li>
            <li><label><input type="checkbox" id="step-18"><span>Clear the waves and kill the boss. Continue north-east,
                        skip the side quest. Follow the main quest marker to The Lower District.</span></label></li>
            <li><label><input type="checkbox" id="step-19"><span>Kill the Elder Pannion. Talk to the NPC and enter the
                        Time
                        Rift to The End of Time.</span></label></li>
            <li><label><input type="checkbox" id="step-20"><span>Run directly up the stairs, talk to Elder Gaspar,
                        choose
                        Mastery, enter The Council Chamber.</span></label></li>
            <!-- Add Objective Placeholder -->
            <li class="add-objective-placeholder" tabindex="0">
                <input type="text" placeholder="Add custom Act 2 objective..." />
                <button class="add-section-objective-button">+</button>
            </li>
        </ul>
    </div>

    <div class="section" id="section-act3">
        <h2><button class="collapse-toggle" aria-label="Collapse/Expand Act 3" tabindex="0">▼</button>Act 3</h2>
        <ul id="act3-list" class="objective-list">
            <li><label><input type="checkbox" id="step-21"><span>Talk to NPCs (main quest, respec NPC) dispel barrier
                        south-east and enter The Sheltered Wood.</span></label></li>
            <li><label><input type="checkbox" id="step-22"><span>Follow main quest marker to The Surface, The Forsaken
                        Trail
                        and Cultist Camp.</span></label></li>
            <li><label><input type="checkbox" id="step-23"><span>Directly head out north to The Ruins of
                        Welryn.</span></label></li>
            <li><label><input type="checkbox" id="step-24"><span>Spiral around to enter Welryn Undercity
                        (south).</span></label></li>
            <li><label><input type="checkbox" id="step-25"><span>Talk to NPC (main quest) and kill the three Soul
                        Repositories (north à east à south-east). Talk to NPC again and portal to town.</span></label>
            </li>
            <li><label><input type="checkbox" id="step-26"><span>Directly go south to Welryn Docks.</span></label></li>
            <li><label><input type="checkbox" id="step-27"><span>Follow main quest marker, kill the Void Centipede, take
                        Symbol of Hope. Portal to town.</span></label></li>
            <li><label><input type="checkbox" id="step-28"><span>Talk to NPC (main quest). Go east to The Ritual
                        Site.</span></label></li>
            <li><label><input type="checkbox" id="step-29"><span>Talk to NPC (main quest) and kill the Void
                        Amalgamation.
                        Continue east to The Shattered Valley.</span></label></li>
            <li><label><input type="checkbox" id="step-30"><span>Go directly north to The Abandoned Tunnel. Follow quest
                        marker to The Lost Refuge (north-east).</span></label></li>
            <li><label><input type="checkbox" id="step-31"><span>Follow quest marker (east), talk to the Old Tome to
                        complete the side quest (2 passives). Take waypoint to The Shattered Valley (a bit south of
                        current
                        location).</span></label></li>
            <li><label><input type="checkbox" id="step-32"><span>Continue south-east, enter Time Rift to The Ancient
                        Forest.
                        Go north-east and kill the Primeval Dragon. Take waypoint to The Shattered Valley in the Ruined
                        Era.</span></label></li>
            <li><label><input type="checkbox" id="step-33"><span>Go south-east again, pass the Time Rift towards
                        north-east
                        (main quest marker). Enter The Courtyard.</span></label></li>
            <li><label><input type="checkbox" id="step-34"><span>Turn south-east at waypoint and follow north towards
                        the
                        main quest marker. Kill the Temple Guardian and enter The Temple of Eterra.</span></label></li>
            <li><label><input type="checkbox" id="step-35"><span>Follow main quest marker (north-east) and enter The
                        Lotus
                        Halls.</span></label></li>
            <li><label><input type="checkbox" id="step-36"><span>Directly go north-west to get one of the Shards (talk
                        to
                        NPC (…), enter Time Rift, take shard), take waypoint to The Council Chambers.</span></label>
            </li>
            <li><label><input type="checkbox" id="step-37"><span>Talk to NPC (respect NPC). Take waypoint to The Lotus
                        Halls. Continue north-east to The Sanctum Bastille.</span></label></li>
            <li><label><input type="checkbox" id="step-38"><span>Follow main quest marker to enter The End of Ruin. Kill
                        the
                        Emperor’s Remains. Talk to NPC to portal to The End of Time.</span></label></li>
            <li><label><input type="checkbox" id="step-39"><span>Directly go upstairs to Elder Gaspar. Enter portal to
                        Imperial Era (The Outcast Camp).</span></label></li>
            <!-- Add Objective Placeholder -->
            <li class="add-objective-placeholder" tabindex="0">
                <input type="text" placeholder="Add custom Act 3 objective..." />
                <button class="add-section-objective-button">+</button>
            </li>
        </ul>
    </div>

    <div class="section" id="section-act4">
        <h2><button class="collapse-toggle" aria-label="Collapse/Expand Act 4" tabindex="0">▼</button>Act 4</h2>
        <ul id="act4-list" class="objective-list">
            <li><label><input type="checkbox" id="step-40"><span>Optionally craft a bit, head south-west to Welryn
                        Outskirts.</span></label></li>
            <li><label><input type="checkbox" id="step-41"><span>Follow quest marker (west) to enter Imperial
                        Welryn.</span></label></li>
            <li><label><input type="checkbox" id="step-42"><span>Ignore quest marker and go north-west to The Soul
                        Wardens’
                        Road.</span></label></li>
            <li><label><input type="checkbox" id="step-43"><span>Kill the zombie waves and continue west to The Risen
                        Lake.</span></label></li>
            <li><label><input type="checkbox" id="step-44"><span>Enter Time Rift to The Corrupted Lake. Go west and
                        spiral
                        around clockwise until you kill the Prophet of Ruin/Idol of Ruin (side quest). Take waypoint to
                        The
                        Risen Lake.</span></label></li>
            <li><label><input type="checkbox" id="step-45"><span>Pass the Time Rift, click the stone for the bridge,
                        ignore
                        quest marker and continue north-east and north-west to enter The Fallen Tower.</span></label>
            </li>
            <li><label><input type="checkbox" id="step-46"><span>Follow quest marker (north-west) to enter Imperial
                        Thetima.</span></label></li>
            <li><label><input type="checkbox" id="step-47"><span>Follow quest marker (west) to enter The Darkling
                        Pier.</span></label></li>
            <li><label><input type="checkbox" id="step-48"><span>Continue east to enter The Imperial
                        Dreadnought.</span></label></li>
            <li><label><input type="checkbox" id="step-49"><span>Follow quest marker (east) to enter The Dreadnought’s
                        Deck.</span></label></li>
            <li><label><input type="checkbox" id="step-50"><span>Follow quest marker (north-west, then west), kill
                        Admiral
                        Harton. Talk to NPCs (Alric) and the Dreadnought’s Railing.</span></label></li>
            <!-- Add Objective Placeholder -->
            <li class="add-objective-placeholder" tabindex="0">
                <input type="text" placeholder="Add custom Act 4 objective..." />
                <button class="add-section-objective-button">+</button>
            </li>
        </ul>
    </div>

    <div class="section" id="section-act5">
        <h2><button class="collapse-toggle" aria-label="Collapse/Expand Act 5" tabindex="0">▼</button>Act 5</h2>
        <ul id="act5-list" class="objective-list">
            <li><label><input type="checkbox" id="step-51"><span>Talk to NPC (Alric). Go north-east to enter The Majasan
                        Desert.</span></label></li>
            <li><label><input type="checkbox" id="step-52"><span>Follow quest marker (north-east), talk to NPC (side
                        quest,
                        Rouj Zabat), enter The Wraith Dunes.</span></label></li>
            <li><label><input type="checkbox" id="step-53"><span>Go north and north-east, follow main quest marker to
                        enter
                        Maj’elka.</span></label></li>
            <li><label><input type="checkbox" id="step-54"><span>Talk to NPC (Alric), go downstairs on the right,
                        continue
                        south-east to main quest marker, kill Venator Ealos, talk to NPC (Alric), continue north-east to
                        main quest marker, on the way talk to NPC lying on the ground (side quest, Rouj Zabat). Continue
                        north (left main quest marker), kill the Bone Furnace. Follow the north-east main quest marker
                        to
                        enter The Sapphire Quarter.</span></label></li>
            <li><label><input type="checkbox" id="step-55"><span>Continue north, kill the Stygian Warden, talk to NPC
                        (Alric), continue north-west and north to main quest marker, kill Praetor Vul’arta, talk to NPC
                        (Alric), enter portal to Maj’elka.</span></label></li>
            <li><label><input type="checkbox" id="step-56"><span>Go east to The Oracle’s Abode. Talk to NPC (side quest,
                        Shrine Maiden). Take waypoint to The Shining Cove.</span></label></li>
            <li><label><input type="checkbox" id="step-57"><span>Go east, enter the Time Rift into The Ruined Coast.
                        Follow
                        the path, kill Ortra’ek the Survivor, click the Sapphire Tablet, enter the Temporal Sanctum to
                        get
                        the waypoint. Take waypoint to The Oracle’s Abode (Imperial Era).</span></label></li>
            <li><label><input type="checkbox" id="step-58"><span>Talk to NPC (side quest, Shrine Maiden). Talk to the
                        Oracle
                        (main quest) and continue north to The Maj’elkan Catacombs.</span></label></li>
            <li><label><input type="checkbox" id="step-59"><span>Go east à south à north-east to follow the main quest
                        marker and enter Titan’s Canyon.</span></label></li>
            <li><label><input type="checkbox" id="step-60"><span>Follow main quest marker, kill Spymaster Zerrick, enter
                        The
                        Maj’elka Waystation.</span></label></li>
            <li><label><input type="checkbox" id="step-61"><span>Follow main quest marker, talk to NPC
                        (Alric).</span></label></li>
            <!-- Add Objective Placeholder -->
            <li class="add-objective-placeholder" tabindex="0">
                <input type="text" placeholder="Add custom Act 5 objective..." />
                <button class="add-section-objective-button">+</button>
            </li>
        </ul>
    </div>

    <div class="section" id="section-act6">
        <h2><button class="collapse-toggle" aria-label="Collapse/Expand Act 6" tabindex="0">▼</button>Act 6</h2>
        <ul id="act6-list" class="objective-list">
            <li><label><input type="checkbox" id="step-62"><span>Talk to NPC (Yulia), go north into The Rust
                        Lands.</span></label></li>
            <li><label><input type="checkbox" id="step-63"><span>Follow main quest marker (east), enter The Lower
                        Sewers.</span></label></li>
            <li><label><input type="checkbox" id="step-64"><span>Follow main quest marker (north à north-west), enter
                        The
                        Barren Aqueduct.</span></label></li>
            <li><label><input type="checkbox" id="step-65"><span>Follow main quest marker (north à north-west), kill the
                        rare mob, talk to NPC (Alric), enter Necropolis of the Deep.</span></label></li>
            <li><label><input type="checkbox" id="step-66"><span>Follow main quest marker (south-east), enter Yulia’s
                        Haven.</span></label></li>
            <li><label><input type="checkbox" id="step-67"><span>Talk to both NPCs (side and main quest), continue
                        north-west into Nests of the Fallen.</span></label></li>
            <li><label><input type="checkbox" id="step-68"><span>Follow side quest marker, kill Ulaca Maggot Tongue.
                        Portal
                        to town.</span></label></li>
            <li><label><input type="checkbox" id="step-69"><span>Talk to NPC (side quest, Alric), enter The Upper
                        Necropolis
                        (south-east).</span></label></li>
            <li><label><input type="checkbox" id="step-70"><span>Follow main quest marker (north-east), enter The
                        Citadel
                        Sewers.</span></label></li>
            <li><label><input type="checkbox" id="step-71"><span>Destroy the three Imperial Watchers (main quest
                        markers,
                        clockwise). Continue south-east (main quest marker), enter The Immortal Summit.</span></label>
            </li>
            <li><label><input type="checkbox" id="step-72"><span>Go south-east, then north-east (main quest marker),
                        enter
                        The Immortal Cidatel.</span></label></li>
            <li><label><input type="checkbox" id="step-73"><span>Talk to NPC (main quest, Yulia), kill Pontifex Yulia,
                        Admiral Harton and Spymaster Zerrick. Talk to NPC (Yulia).</span></label></li>
            <!-- Add Objective Placeholder -->
            <li class="add-objective-placeholder" tabindex="0">
                <input type="text" placeholder="Add custom Act 6 objective..." />
                <button class="add-section-objective-button">+</button>
            </li>
        </ul>
    </div>

    <div class="section" id="section-act7">
        <h2><button class="collapse-toggle" aria-label="Collapse/Expand Act 7" tabindex="0">▼</button>Act 7</h2>
        <ul id="act7-list" class="objective-list">
            <li><label><input type="checkbox" id="step-74"><span>Go south-west, then north-west/west towards the main
                        quest
                        marker, enter The Burning Forest.</span></label></li>
            <li><label><input type="checkbox" id="step-75"><span>Follow main quest marker (south-west), enter The
                        Scorched
                        Grove. Help and talk to NPC (Heorot), talk to NPC (Yulia).</span></label></li>
            <li><label><input type="checkbox" id="step-76"><span>In town, talk to NPC (Chieftan Yulia) and side quest
                        NPC
                        (Medicine Man), enter The Heoborean Forest (west).</span></label></li>
            <li><label><input type="checkbox" id="step-77"><span>Enter The Ice Caverns (north). Acquire a Bitterwing
                        fang
                        (north-west marker). Take waypoint to The Heoborean Forest.</span></label></li>
            <li><label><input type="checkbox" id="step-78"><span>Continue west to quest marker, enter The Nomad Camp.
                        Talk
                        to NPC (main quest, Nomad Survivor). Follow quest marker (west), enter The Wengari
                        Fortress.</span></label></li>
            <li><label><input type="checkbox" id="step-79"><span>Follow side quest markers to find the right camp (start
                        north-east). Kill Wengari Beastmaster. Follow main quest marker (north), kill Wengari Matriarch
                        and
                        Patriarch. Talk to NPC (Blessed Horn). Continue south-west (side quest marker). Take waypoint to
                        The
                        Ice Caverns.</span></label></li>
            <li><label><input type="checkbox" id="step-80"><span>Go north-east / north (main and side quest marker),
                        enter
                        The Tundra.</span></label></li>
            <li><label><input type="checkbox" id="step-81"><span>Kill the Eber (north) and continue north (main quest
                        marker), talk to NPC (cliff edge), enter The Temple of Heorot.</span></label></li>
            <li><label><input type="checkbox" id="step-82"><span>Follow main quest marker (north), skip the Spreading
                        Frost
                        and enter Farwood.</span></label></li>
            <li><label><input type="checkbox" id="step-83"><span>Continue north-east (main quest marker), enter The
                        Frozen
                        Roots.</span></label></li>
            <li><label><input type="checkbox" id="step-84"><span>Talk to NPC (main quest, Grael), continue north-east
                        (main
                        quest marker), enter The Tomb of Morditas. Kill the Frostroot Warden. Talk to NPC (Lance of
                        Heorot
                        and Grael).</span></label></li>
            <li><label><input type="checkbox" id="step-85"><span>Hand in quests in town (side and main
                        quests).</span></label></li>
            <!-- Add Objective Placeholder -->
            <li class="add-objective-placeholder" tabindex="0">
                <input type="text" placeholder="Add custom Act 7 objective..." />
                <button class="add-section-objective-button">+</button>
            </li>
        </ul>
    </div>

    <div class="section" id="section-endgame">
        <h2><button class="collapse-toggle" aria-label="Collapse/Expand Endgame" tabindex="0">▼</button>Endgame</h2>
        <ul id="endgame-list" class="objective-list">
            <li><label><input type="checkbox" id="step-end-1"><span>Start running Monos, look for a temporal sanctum
                        key.</span></label></li>
            <li><label><input type="checkbox" id="step-end-2"><span>Run temporal sanctum and exit to act
                        9.</span></label>
            </li>
            <li><label><input type="checkbox" id="step-end-3"><span>Finish act 9, run additional dungeons, continue
                        farming
                        monos.</span></label></li>
            <li><label><input type="checkbox" id="step-end-4"><span>Get some rest, you earned it!</span></label></li>
            <!-- Add Objective Placeholder -->
            <li class="add-objective-placeholder" tabindex="0">
                <input type="text" placeholder="Add custom Endgame objective..." />
                <button class="add-section-objective-button">+</button>
            </li>
        </ul>
    </div>

    <div id="image-modal" class="image-modal">
        <button class="image-modal-close" aria-label="Close image">&times;</button>
        <img src="" alt="Full size custom objective image" />
    </div>

    <script>
        // --- DOM Elements ---
        const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
        const predefinedCheckboxes = document.querySelectorAll('.objective-list li:not(.custom-objective-item):not(.add-objective-placeholder) input[type="checkbox"]');
        const objectiveLists = document.querySelectorAll('ul.objective-list');
        const clearAllStorageButton = document.getElementById('clearAllStorageButton');
        const clearChecksButton = document.getElementById('clearChecksButton');
        const clearCustomObjectivesButton = document.getElementById('clearCustomObjectivesButton');

        // --- Storage Keys ---
        const predefinedStorageKey = 'checklistState';
        const customStorageKey = 'customObjectivesData';
        const collapsedStorageKey = 'collapsedSections'; // Added for consistency

        // --- State Variables ---
        let draggedItem = null;

        // --- Utility Functions ---
        function updateStyle(checkbox) {
            const label = checkbox.closest('label');
            const textSpan = label?.querySelector('span');
            const targetElement = textSpan || label;

            if (targetElement) {
                if (checkbox.checked) {
                    targetElement.classList.add('checked-text');
                } else {
                    targetElement.classList.remove('checked-text');
                }
            }
        }

        // --- Predefined Objectives Logic ---
        function savePredefinedState() {
            const state = {};
            predefinedCheckboxes.forEach(cb => {
                if (cb.id) {
                    state[cb.id] = cb.checked;
                }
            });
            localStorage.setItem(predefinedStorageKey, JSON.stringify(state));
        }

        function loadPredefinedState() {
            const savedState = localStorage.getItem(predefinedStorageKey);
            let state = {};
            if (savedState) {
                try {
                    state = JSON.parse(savedState);
                } catch (e) {
                    console.error("Error parsing predefined checklist state:", e);
                    localStorage.removeItem(predefinedStorageKey);
                }
            }
            predefinedCheckboxes.forEach(cb => {
                if (cb.id && state.hasOwnProperty(cb.id)) {
                    cb.checked = state[cb.id];
                } else {
                    cb.checked = false;
                }
                updateStyle(cb);
            });
        }

        // --- Custom Objectives Logic ---
        function createCustomObjectiveElement(objData) { // objData = { text: string, checked: boolean, image?: string }
            const li = document.createElement('li');
            li.classList.add('custom-objective-item');
            li.draggable = true;

            const label = document.createElement('label');
            let img = null;
            if (objData.image) {
                img = document.createElement('img');
                img.src = objData.image;
                img.className = 'custom-objective-image';
                img.alt = 'Custom objective image';
                img.tabIndex = 0;
                img.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showImageModal(objData.image);
                });
                img.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        showImageModal(objData.image);
                    }
                });
                label.appendChild(img);
            }

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = objData.checked || false;

            const span = document.createElement('span');
            span.textContent = objData.text || (objData.image ? '' : 'New Objective'); // Provide default if text is empty but image exists
            span.style.cursor = 'text'; // Indicate text is editable

            span.addEventListener('click', function handleSpanClick(e) {
                // Prevent triggering edit if already editing
                if (label.querySelector('.custom-objective-edit-input')) return;

                const currentText = span.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentText;
                input.className = 'custom-objective-edit-input';

                function saveEdit() {
                    const newText = input.value.trim();
                    span.textContent = newText || (objData.image ? '' : 'New Objective'); // Restore default if empty
                    input.replaceWith(span);
                    saveCustomObjectives();
                    // Re-attach click listener after replacing
                    span.addEventListener('click', handleSpanClick);
                }

                input.addEventListener('keydown', function (ev) {
                    if (ev.key === 'Enter') {
                        saveEdit();
                        ev.preventDefault(); // Prevent potential form submission
                    } else if (ev.key === 'Escape') {
                        input.replaceWith(span); // Revert without saving
                        span.addEventListener('click', handleSpanClick); // Re-attach
                    }
                });
                input.addEventListener('blur', saveEdit); // Save on blur

                // Remove original click listener while editing
                span.removeEventListener('click', handleSpanClick);
                label.replaceChild(input, span);
                input.select(); // Select text for easy replacement
                input.focus();
            });

            const removeButton = document.createElement('button');
            removeButton.textContent = '×';
            removeButton.className = 'remove-objective-button';
            removeButton.title = 'Remove objective';
            removeButton.setAttribute('aria-label', 'Remove objective');

            checkbox.addEventListener('change', () => {
                updateStyle(checkbox);
                saveCustomObjectives();
            });

            removeButton.addEventListener('click', () => {
                li.remove();
                saveCustomObjectives();
            });

            label.appendChild(checkbox);
            label.appendChild(span);
            li.appendChild(label);
            li.appendChild(removeButton);

            li.addEventListener('dragstart', handleDragStart);
            li.addEventListener('dragend', handleDragEnd);

            updateStyle(checkbox);
            return li;
        }

        function saveCustomObjectives() {
            const customObjectivesData = [];
            const lists = document.querySelectorAll('ul.objective-list');

            lists.forEach(ul => {
                const sectionId = ul.id;
                if (!sectionId) return;

                const lis = Array.from(ul.children);
                lis.forEach((li, idx) => {
                    if (li.classList.contains('custom-objective-item')) {
                        const checkbox = li.querySelector('input[type="checkbox"]');
                        const span = li.querySelector('label span'); // Target the span inside label
                        const img = li.querySelector('img.custom-objective-image');
                        const imageSrc = img ? img.src : undefined;

                        if (checkbox && span) {
                            customObjectivesData.push({
                                sectionId: sectionId,
                                text: span.textContent,
                                checked: checkbox.checked,
                                index: idx, // Save the actual index within the list
                                image: imageSrc
                            });
                        }
                    }
                });
            });
            localStorage.setItem(customStorageKey, JSON.stringify(customObjectivesData));
        }


        function loadCustomObjectives() {
            document.querySelectorAll('li.custom-objective-item').forEach(item => item.remove());

            const savedData = localStorage.getItem(customStorageKey);
            if (savedData) {
                try {
                    const customObjectivesData = JSON.parse(savedData);
                    if (Array.isArray(customObjectivesData)) {
                        // Group by section first to maintain relative order within sections
                        const sectionsMap = {};
                        customObjectivesData.forEach(objData => {
                            if (!sectionsMap[objData.sectionId]) sectionsMap[objData.sectionId] = [];
                            sectionsMap[objData.sectionId].push(objData);
                        });

                        // Sort within each section by saved index
                        for (const sectionId in sectionsMap) {
                            sectionsMap[sectionId].sort((a, b) => (a.index ?? 0) - (b.index ?? 0));
                        }

                        // Now iterate through the sorted data and insert
                        customObjectivesData.forEach(objData => {
                            const targetList = document.getElementById(objData.sectionId);
                            if (targetList) {
                                const li = createCustomObjectiveElement({
                                    text: objData.text,
                                    checked: objData.checked,
                                    image: objData.image
                                });

                                // Insert at the correct position based on saved index
                                const children = targetList.children;
                                const targetNode = children[objData.index] || targetList.querySelector('.add-objective-placeholder') || null;
                                targetList.insertBefore(li, targetNode);
                            } else {
                                console.warn(`Target list ${objData.sectionId} not found for custom objective.`);
                            }
                        });

                    } else {
                        console.error("Custom objectives data is not an array:", customObjectivesData);
                        localStorage.removeItem(customStorageKey);
                    }
                } catch (e) {
                    console.error("Error parsing custom objectives from localStorage:", e);
                    localStorage.removeItem(customStorageKey);
                }
            }
        }


        function addCustomObjective(placeholderLi, imageDataURL = null) {
            const inputField = placeholderLi?.querySelector('input[type="text"]');
            const targetList = placeholderLi?.closest('ul.objective-list');

            if (!placeholderLi || !inputField || !targetList || !targetList.id) {
                console.error("Could not find required elements for adding objective.");
                return;
            }

            const text = inputField.value.trim();
            // Require either text or an image to add an objective
            if (text || imageDataURL) {
                const newObjData = { text: text, checked: false };
                if (imageDataURL) newObjData.image = imageDataURL;
                const li = createCustomObjectiveElement(newObjData);

                // Insert the new item *before* the placeholder li
                targetList.insertBefore(li, placeholderLi);

                saveCustomObjectives(); // Save the updated list
                inputField.value = ''; // Clear the input field
                inputField.focus(); // Keep focus in the input for quick adding
            }
        }

        // --- Drag and Drop Handlers ---
        function handleDragStart(event) {
            // Only allow dragging custom objective items
            if (event.target.classList.contains('custom-objective-item')) {
                draggedItem = event.target;
                setTimeout(() => { // Use timeout to ensure style applies after drag starts
                    draggedItem.classList.add('dragging');
                }, 0);
                event.dataTransfer.effectAllowed = 'move';
                // Optional: Set data for potential cross-list dragging (though not implemented here)
                // event.dataTransfer.setData('text/plain', draggedItem.id); // Needs IDs on items
            } else {
                event.preventDefault(); // Prevent dragging non-custom items
            }
        }

        function handleDragEnd(event) {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            // Clean up any remaining indicators
            document.querySelectorAll('.drag-over-indicator').forEach(indicator => {
                indicator.classList.remove('drag-over-indicator');
            });
            draggedItem = null;
        }

        function handleDragOver(event) {
            event.preventDefault(); // Necessary to allow drop
            if (!draggedItem) return; // Only respond if dragging a valid item

            const targetList = event.target.closest('ul.objective-list');
            if (!targetList) return; // Not over a valid list

            event.dataTransfer.dropEffect = 'move';

            // Find the list item being hovered over
            let targetLi = event.target.closest('li');

            // Clear previous indicators
            targetList.querySelectorAll('.drag-over-indicator').forEach(el => el.classList.remove('drag-over-indicator'));

            // Determine where to show the indicator
            if (targetLi && targetLi !== draggedItem && !targetLi.classList.contains('add-objective-placeholder')) {
                // Show indicator *before* the target list item
                targetLi.classList.add('drag-over-indicator');
            } else if (targetLi && targetLi.classList.contains('add-objective-placeholder')) {
                // If over placeholder, show indicator before it (effectively at the end)
                targetLi.classList.add('drag-over-indicator');
            }
            // If hovering over empty space in the list, or over the dragged item itself, no indicator needed here
            // (Drop handler will append to end if no specific target is found)
        }


        function handleDrop(event) {
            event.preventDefault();
            if (!draggedItem) return; // Only handle drops of our custom items

            const targetList = event.target.closest('ul.objective-list');
            if (!targetList) { // Should not happen if dragOver worked, but good safety check
                handleDragEnd(event); // Clean up
                return;
            }

            // Find the element the indicator was placed on (or the placeholder)
            const dropTarget = targetList.querySelector('.drag-over-indicator');

            if (dropTarget) {
                // Insert the dragged item *before* the element with the indicator
                targetList.insertBefore(draggedItem, dropTarget);
            } else {
                // If no specific drop target (e.g., dropped in empty space below items),
                // append before the placeholder, or just append if no placeholder exists.
                const placeholder = targetList.querySelector('.add-objective-placeholder');
                if (placeholder) {
                    targetList.insertBefore(draggedItem, placeholder);
                } else {
                    targetList.appendChild(draggedItem); // Fallback
                }
            }

            // Clean up indicator class from the target element (which is now the element *after* the dropped item)
            if (dropTarget) {
                dropTarget.classList.remove('drag-over-indicator');
            }

            saveCustomObjectives(); // Save the new order
            handleDragEnd(event); // General cleanup
        }

        // --- Add Placeholder Drag/Drop/Paste Listeners ---
        function setupPlaceholderListeners(placeholder) {
            // Drag Over/Enter/Leave for visual feedback
            placeholder.addEventListener('dragover', (event) => {
                event.preventDefault(); // Allow drop
                // Only add class if dataTransfer contains files (not our list items)
                if (event.dataTransfer.types.includes('Files')) {
                    placeholder.classList.add('dragover');
                    event.dataTransfer.dropEffect = 'copy'; // Indicate copying file
                } else {
                    event.dataTransfer.dropEffect = 'none'; // Prevent dropping list items here
                }
            });
            placeholder.addEventListener('dragenter', (event) => {
                event.preventDefault();
                if (event.dataTransfer.types.includes('Files')) {
                    placeholder.classList.add('dragover');
                }
            });
            placeholder.addEventListener('dragleave', (event) => {
                // Check if the leave event is going outside the placeholder bounds
                if (!placeholder.contains(event.relatedTarget)) {
                    placeholder.classList.remove('dragover');
                }
            });

            // Drop Handler for Files
            placeholder.addEventListener('drop', (event) => {
                event.preventDefault();
                event.stopPropagation(); // *** FIX: Prevent bubbling to the list's drop handler ***
                placeholder.classList.remove('dragover');

                const files = event.dataTransfer.files;
                if (files && files.length > 0) {
                    const file = files[0]; // Handle first file
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            // Use 'placeholder' (which is the 'li' element) directly
                            addCustomObjective(placeholder, e.target.result);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        alert('Only image files can be dropped here.');
                    }
                }
            });

            // Paste Handler
            placeholder.addEventListener('paste', (event) => {
                const items = (event.clipboardData || window.clipboardData)?.items;
                if (!items) return;

                let imageFound = false;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].kind === 'file' && items[i].type.startsWith('image/')) {
                        event.preventDefault(); // Prevent default paste action (like pasting text)
                        const file = items[i].getAsFile();
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                // Use 'placeholder' (which is the 'li' element) directly
                                addCustomObjective(placeholder, e.target.result);
                            };
                            reader.readAsDataURL(file);
                            imageFound = true;
                            break; // Handle first image found
                        }
                    }
                }
                // Optional: Provide feedback if paste didn't contain an image?
                // if (!imageFound) { console.log("Paste did not contain a recognized image file."); }
            });
        }


        // --- Clearing Functions ---
        function clearAllChecks() {
            if (confirm("Are you sure you want to clear all check marks?")) {
                allCheckboxes.forEach(cb => {
                    cb.checked = false;
                    updateStyle(cb);
                });
                localStorage.removeItem(predefinedStorageKey);
                // Update custom objectives to be unchecked and save
                document.querySelectorAll('li.custom-objective-item input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                    updateStyle(cb); // Ensure visual update
                });
                saveCustomObjectives(); // Save the unchecked state
            }
        }

        function clearCustomObjectives() {
            if (confirm("Are you sure you want to clear ALL custom objectives? This cannot be undone.")) {
                document.querySelectorAll('li.custom-objective-item').forEach(item => item.remove());
                localStorage.removeItem(customStorageKey);
            }
        }

        function clearAllStorage() {
            if (confirm("WARNING: This will clear ALL check marks AND remove ALL custom objectives permanently. Are you sure?")) {
                allCheckboxes.forEach(cb => {
                    cb.checked = false;
                    updateStyle(cb);
                });
                document.querySelectorAll('li.custom-objective-item').forEach(item => item.remove());
                localStorage.removeItem(predefinedStorageKey);
                localStorage.removeItem(customStorageKey);
                // Also clear collapsed state if desired
                localStorage.removeItem(collapsedStorageKey);
                // Optionally reload or reset collapse state visually
                document.querySelectorAll('.section.collapsed').forEach(section => {
                    section.classList.remove('collapsed');
                    const btn = section.querySelector('.collapse-toggle');
                    if (btn) btn.textContent = '▼';
                });
            }
        }

        // --- Modal Logic ---
        const imageModal = document.getElementById('image-modal');
        const modalImage = imageModal.querySelector('img');
        const modalCloseButton = imageModal.querySelector('.image-modal-close');

        function showImageModal(src) {
            modalImage.src = src;
            imageModal.classList.add('active');
            modalCloseButton.focus(); // Focus close button for accessibility
        }

        function hideImageModal() {
            imageModal.classList.remove('active');
            modalImage.src = '';
        }

        // --- Event Listeners Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPredefinedState();
            loadCustomObjectives(); // Load custom objectives first

            // Load collapsed state
            const collapsedSections = JSON.parse(localStorage.getItem(collapsedStorageKey) || '{}');
            document.querySelectorAll('.section').forEach(section => {
                const sectionId = section.id;
                if (sectionId && collapsedSections[sectionId]) {
                    section.classList.add('collapsed');
                    const btn = section.querySelector('.collapse-toggle');
                    if (btn) btn.textContent = '►';
                }
            });

            // Add listeners to existing placeholders
            document.querySelectorAll('.add-objective-placeholder').forEach(setupPlaceholderListeners);

            // Add list-level drag/drop listeners for reordering items
            objectiveLists.forEach(list => {
                list.addEventListener('dragover', handleDragOver);
                list.addEventListener('drop', handleDrop);
                // Optional: dragleave on list might be needed for cleanup in complex scenarios
                // list.addEventListener('dragleave', handleDragLeave);
            });


            // Modal close listeners
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal || e.target === modalCloseButton) {
                    hideImageModal();
                }
            });
            modalCloseButton.addEventListener('click', hideImageModal);
            imageModal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideImageModal();
                }
            });


            // Event Delegation for dynamic elements and common actions
            document.body.addEventListener('click', (event) => {
                // Add Objective Button
                if (event.target.classList.contains('add-section-objective-button')) {
                    const placeholderLi = event.target.closest('.add-objective-placeholder');
                    if (placeholderLi) {
                        addCustomObjective(placeholderLi); // Add text-only objective
                    }
                }
                // Predefined Checkbox Change
                else if (event.target.matches('.objective-list li:not(.custom-objective-item):not(.add-objective-placeholder) input[type="checkbox"][id]')) {
                    updateStyle(event.target);
                    savePredefinedState();
                }
                // Collapse Toggle Button
                else if (event.target.classList.contains('collapse-toggle')) {
                    const section = event.target.closest('.section');
                    if (section) {
                        const isCollapsed = section.classList.toggle('collapsed');
                        event.target.textContent = isCollapsed ? '►' : '▼';
                        // Save collapsed state
                        const currentCollapsed = JSON.parse(localStorage.getItem(collapsedStorageKey) || '{}');
                        if (section.id) {
                            currentCollapsed[section.id] = isCollapsed;
                            localStorage.setItem(collapsedStorageKey, JSON.stringify(currentCollapsed));
                        }
                    }
                }
                // Note: Custom checkbox changes/removals handled by listeners in createCustomObjectiveElement
            });

            // Enter key in placeholder input
            document.body.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' && event.target.matches('.add-objective-placeholder input[type="text"]')) {
                    const placeholderLi = event.target.closest('.add-objective-placeholder');
                    if (placeholderLi) {
                        addCustomObjective(placeholderLi);
                        event.preventDefault();
                    }
                }
            });

            // Keyboard accessibility for toggle buttons
            document.body.addEventListener('keydown', (event) => {
                if (event.target.classList.contains('collapse-toggle') && (event.key === 'Enter' || event.key === ' ')) {
                    event.preventDefault();
                    event.target.click();
                }
            });

            // Main control buttons
            clearAllStorageButton.addEventListener('click', clearAllStorage);
            clearChecksButton.addEventListener('click', clearAllChecks);
            clearCustomObjectivesButton.addEventListener('click', clearCustomObjectives);
        });

        // Listeners for the main clear buttons
        clearAllStorageButton.addEventListener('click', clearAllStorage);
        clearChecksButton.addEventListener('click', clearAllChecks);
        clearCustomObjectivesButton.addEventListener('click', clearCustomObjectives);


    </script>
</body>

</html>